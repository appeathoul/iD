import {
    select as d3_select,
    selectAll as d3_selectAll
} from 'd3-selection';

import { t, textDirection } from '../../util/locale';
import { dispatch as d3_dispatch } from 'd3-dispatch';
import { utilFunctor } from '../../util/index';
import { tooltip } from '../../util/tooltip';
import { uiTooltipHtml } from '../tooltipHtml';

export function uiLegend(context) {
    var osm, history, hash, center, zoom, background, overlays, layers;
    var dispatch = d3_dispatch(
        // 隐藏图层
        'hide',
        // 显示图层
        'show'
    );
    var legendData = [{
        id: 'authData',
        text: '权限数据',
        color: '#ff26d4',
        title: '用户只能编辑权限范围内的数据'
    }, {
        id: 'ViewData',
        text: '可查看数据',
        color: '#5c94f9',
        title: '只能查看，不可编辑的数据'
    }];
    function legend(selection) {
        osm = context.connection();
        history = context.history().toJSON();
        hash = window.location.hash;
        center = context.map().center();
        zoom = context.map().zoom();
        layers = context.layers();
        background = context.background().baseLayerSource();
        overlays = context.background().overlayLayerSources();
        var wrapper = selection
            .append('div')
            .attr('class', 'legend_wrapper');
        wrapper.call(render);
        // 渲染地图权限图层
        getAuthLayer();
    }

    function render(wrapper) {
        var wrapperBorder = wrapper
            .append('div')
            .attr('class', 'legend_wrapper_border');
        var enter = wrapperBorder.selectAll('.legend_item')
            .data(legendData)
            .enter()
            .append('div')
            .attr('class', 'legend_item').each(function (d) {
                var tooltipBehavior = tooltip()
                    .placement('left')
                    .html(true)
                    .title(uiTooltipHtml(d.title));
                d3_select(this)
                    .call(tooltipBehavior);
            });

        enter.on('click', function (d) {
            var layer = layers.layer('data');
            var select = d3_select(this);
            if (select.classed('nochecked')) {
                select.classed('nochecked', false);
            } else {
                select.classed('nochecked', true);
            }
            if (d.id === 'authData') {
                layer.enabled(!select.classed('nochecked'));
            } else if (d.id === 'ViewData') {
                //
            }
        });

        enter.append('div')
            .attr('class', 'legend_color')
            .style('background-color', function (d) { return d.color; });
        enter.append('span')
            .attr('class', 'legend_span')
            .text(function (d) { return d.text; })
            .merge(wrapperBorder);
    }

    function getAuthLayer() {
        var layer = layers.layer('data');
        osm.userDetails(function (err, details) {
            var geojson = {
                'type': 'FeatureCollection',
                'features': [
                    {
                        'geometry': {
                            'coordinates': [
                                [
                                    [
                                        108.9528569367139,
                                        34.91149053008207
                                    ],
                                    [
                                        108.9542498550594,
                                        34.91066121992468
                                    ],
                                    [
                                        108.9633230453404,
                                        34.91157387537257
                                    ],
                                    [
                                        108.9645619590201,
                                        34.90737367852698
                                    ],
                                    [
                                        108.9654668510139,
                                        34.90563655812476
                                    ],
                                    [
                                        108.9671754989374,
                                        34.90375839607485
                                    ],
                                    [
                                        108.9709257793773,
                                        34.9021258781759
                                    ],
                                    [
                                        108.9717299066108,
                                        34.90180682587602
                                    ],
                                    [
                                        108.9736455705638,
                                        34.89811058767938
                                    ],
                                    [
                                        108.9748575356124,
                                        34.89698051113247
                                    ],
                                    [
                                        108.9764780581196,
                                        34.89546834984994
                                    ],
                                    [
                                        108.9796399442774,
                                        34.89419600017975
                                    ],
                                    [
                                        108.9856503139851,
                                        34.8934265890153
                                    ],
                                    [
                                        108.9868810623961,
                                        34.89257250422426
                                    ],
                                    [
                                        108.9893339415207,
                                        34.89054737305573
                                    ],
                                    [
                                        108.9873882676362,
                                        34.89095751639442
                                    ],
                                    [
                                        108.9855884004424,
                                        34.89113762530864
                                    ],
                                    [
                                        108.9832233980478,
                                        34.89125874740585
                                    ],
                                    [
                                        108.9813465332215,
                                        34.89127392112228
                                    ],
                                    [
                                        108.9796068299186,
                                        34.89110999614947
                                    ],
                                    [
                                        108.9775172600134,
                                        34.89071319505978
                                    ],
                                    [
                                        108.9766771180547,
                                        34.89031430564275
                                    ],
                                    [
                                        108.9744504322723,
                                        34.88958049084469
                                    ],
                                    [
                                        108.972565720618,
                                        34.8889557347548
                                    ],
                                    [
                                        108.9705449630447,
                                        34.88822795662676
                                    ],
                                    [
                                        108.9684623110656,
                                        34.88754420943121
                                    ],
                                    [
                                        108.966791450281,
                                        34.88703646212581
                                    ],
                                    [
                                        108.965531652763,
                                        34.88652956829731
                                    ],
                                    [
                                        108.9645569337046,
                                        34.88572870052926
                                    ],
                                    [
                                        108.9637089168432,
                                        34.88453388831638
                                    ],
                                    [
                                        108.9626560983601,
                                        34.88265600780643
                                    ],
                                    [
                                        108.9618782755913,
                                        34.88025213117819
                                    ],
                                    [
                                        108.9617263834095,
                                        34.87853909460731
                                    ],
                                    [
                                        108.9616425195019,
                                        34.87647018853847
                                    ],
                                    [
                                        108.9616274037396,
                                        34.87395811288218
                                    ],
                                    [
                                        108.9618865598577,
                                        34.87109715787167
                                    ],
                                    [
                                        108.9624203485449,
                                        34.86788804405103
                                    ],
                                    [
                                        108.9625502868399,
                                        34.8665180466761
                                    ],
                                    [
                                        108.9625423690036,
                                        34.86525804882013
                                    ],
                                    [
                                        108.9628630755054,
                                        34.8621610158486
                                    ],
                                    [
                                        108.962718381549,
                                        34.86044896765213
                                    ],
                                    [
                                        108.9631913410416,
                                        34.85913193201237
                                    ],
                                    [
                                        108.9637402481466,
                                        34.8583318460785
                                    ],
                                    [
                                        108.9646408179814,
                                        34.85718170328264
                                    ],
                                    [
                                        108.9653948945579,
                                        34.85614966236451
                                    ],
                                    [
                                        108.9669134923525,
                                        34.85413841428764
                                    ],
                                    [
                                        108.9680124023038,
                                        34.85299329513938
                                    ],
                                    [
                                        108.9688431570104,
                                        34.85184524266799
                                    ],
                                    [
                                        108.9691793476654,
                                        34.85047117249876
                                    ],
                                    [
                                        108.9695911273651,
                                        34.84949615325717
                                    ],
                                    [
                                        108.9696523190845,
                                        34.84840408668249
                                    ],
                                    [
                                        108.9706130210977,
                                        34.84634801393188
                                    ],
                                    [
                                        108.9707429631815,
                                        34.84536798941648
                                    ],
                                    [
                                        108.9709409357469,
                                        34.84427995711017
                                    ],
                                    [
                                        108.9710787968407,
                                        34.84336590176021
                                    ],
                                    [
                                        108.9712008207329,
                                        34.84170889881713
                                    ],
                                    [
                                        108.9714679043851,
                                        34.84004593926278
                                    ],
                                    [
                                        108.9715287369182,
                                        34.83850693335688
                                    ],
                                    [
                                        108.9715208191674,
                                        34.83678487542703
                                    ],
                                    [
                                        108.97165076199,
                                        34.8354158715097
                                    ],
                                    [
                                        108.9715668947216,
                                        34.83381388213057
                                    ],
                                    [
                                        108.9714218356162,
                                        34.83283586936602
                                    ],
                                    [
                                        108.9707890457444,
                                        34.83158197338709
                                    ],
                                    [
                                        108.9698053085847,
                                        34.83027610061991
                                    ],
                                    [
                                        108.9692401925829,
                                        34.82918617957827
                                    ],
                                    [
                                        108.9688212159134,
                                        34.82798923159258
                                    ],
                                    [
                                        108.9683932413256,
                                        34.82673027530808
                                    ],
                                    [
                                        108.9683183735558,
                                        34.82541232541672
                                    ],
                                    [
                                        108.9680275388193,
                                        34.82404733259948
                                    ],
                                    [
                                        108.9678144522824,
                                        34.82289932008681
                                    ],
                                    [
                                        108.9680203409633,
                                        34.82244335443064
                                    ],
                                    [
                                        108.9645490549824,
                                        34.82291477856469
                                    ],
                                    [
                                        108.9632982655422,
                                        34.82292296115116
                                    ],
                                    [
                                        108.9617724898584,
                                        34.82298113778376
                                    ],
                                    [
                                        108.9607956231945,
                                        34.82321329983201
                                    ],
                                    [
                                        108.9594840209775,
                                        34.82356449467965
                                    ],
                                    [
                                        108.9581641458995,
                                        34.82407967535433
                                    ],
                                    [
                                        108.9565012621687,
                                        34.82517793443606
                                    ],
                                    [
                                        108.9556777416113,
                                        34.82638307499327
                                    ],
                                    [
                                        108.9551356872219,
                                        34.8279871414014
                                    ],
                                    [
                                        108.9537560813205,
                                        34.82982138579642
                                    ],
                                    [
                                        108.952718051634,
                                        34.83051554801178
                                    ],
                                    [
                                        108.9516803850775,
                                        34.8309737327981
                                    ],
                                    [
                                        108.9498728443422,
                                        34.83110202340802
                                    ],
                                    [
                                        108.948903931264,
                                        34.83110120286204
                                    ],
                                    [
                                        108.9473022786057,
                                        34.83104649728981
                                    ],
                                    [
                                        108.9468135049335,
                                        34.832786644163
                                    ],
                                    [
                                        108.9468725314279,
                                        34.83376160299227
                                    ],
                                    [
                                        108.9478482769434,
                                        34.8357453871281
                                    ],
                                    [
                                        108.948460141858,
                                        34.8402583258733
                                    ],
                                    [
                                        108.9484169498854,
                                        34.8426513420562
                                    ],
                                    [
                                        108.9475113859185,
                                        34.84398944233239
                                    ],
                                    [
                                        108.9465475172407,
                                        34.8446196152327
                                    ],
                                    [
                                        108.94526080312,
                                        34.844897859216
                                    ],
                                    [
                                        108.9440259212146,
                                        34.8449111368521
                                    ],
                                    [
                                        108.9431682362732,
                                        34.84509624647085
                                    ],
                                    [
                                        108.9421025201084,
                                        34.84679150569723
                                    ],
                                    [
                                        108.9411516188022,
                                        34.85007965396126
                                    ],
                                    [
                                        108.9408917584564,
                                        34.85185369236909
                                    ],
                                    [
                                        108.9398771555021,
                                        34.85306087603628
                                    ],
                                    [
                                        108.9388611151042,
                                        34.85378008188647
                                    ],
                                    [
                                        108.9376805962427,
                                        34.85383629185769
                                    ],
                                    [
                                        108.9366048147589,
                                        34.85344851341151
                                    ],
                                    [
                                        108.935585181357,
                                        34.85350271508451
                                    ],
                                    [
                                        108.9338694797404,
                                        34.85409606707193
                                    ],
                                    [
                                        108.9311359550355,
                                        34.85496565894275
                                    ],
                                    [
                                        108.930008356538,
                                        34.85497686903857
                                    ],
                                    [
                                        108.9282879890912,
                                        34.85428620273595
                                    ],
                                    [
                                        108.9261904404575,
                                        34.85350966711972
                                    ],
                                    [
                                        108.9246856638968,
                                        34.85321496043736
                                    ],
                                    [
                                        108.9229141972803,
                                        34.85318833074674
                                    ],
                                    [
                                        108.9213064901669,
                                        34.85378068773441
                                    ],
                                    [
                                        108.9184175146176,
                                        34.85598125479837
                                    ],
                                    [
                                        108.9159100421711,
                                        34.85919676218023
                                    ],
                                    [
                                        108.9145711884925,
                                        34.85991911444634
                                    ],
                                    [
                                        108.9134436002902,
                                        34.85993033242251
                                    ],
                                    [
                                        108.912743941419,
                                        34.85940542030052
                                    ],
                                    [
                                        108.9119848980447,
                                        34.85799564108855
                                    ],
                                    [
                                        108.9115551691084,
                                        34.85786667167994
                                    ],
                                    [
                                        108.9082289061583,
                                        34.85829937005658
                                    ],
                                    [
                                        108.8990134406326,
                                        34.862115289048
                                    ],
                                    [
                                        108.8996112514611,
                                        34.86322621729879
                                    ],
                                    [
                                        108.8998531108617,
                                        34.86433109757663
                                    ],
                                    [
                                        108.899936249951,
                                        34.86504613028362
                                    ],
                                    [
                                        108.8999402088002,
                                        34.86589311900722
                                    ],
                                    [
                                        108.8998660671317,
                                        34.86693515349206
                                    ],
                                    [
                                        108.8996342848337,
                                        34.86791521001542
                                    ],
                                    [
                                        108.8996360842746,
                                        34.86850119931489
                                    ],
                                    [
                                        108.8996400431514,
                                        34.86921714809891
                                    ],
                                    [
                                        108.8996440020043,
                                        34.870063146804
                                    ],
                                    [
                                        108.899489240491,
                                        34.87078119779226
                                    ],
                                    [
                                        108.8994132993217,
                                        34.87136819285016
                                    ],
                                    [
                                        108.8994172582015,
                                        34.87208522162267
                                    ],
                                    [
                                        108.8997361384707,
                                        34.87286311643688
                                    ],
                                    [
                                        108.9002918393584,
                                        34.87357400297726
                                    ],
                                    [
                                        108.9006898994495,
                                        34.87428600139199
                                    ],
                                    [
                                        108.9011667795373,
                                        34.87506287349609
                                    ],
                                    [
                                        108.901247759085,
                                        34.87551780665051
                                    ],
                                    [
                                        108.9012488387619,
                                        34.87577781626786
                                    ],
                                    [
                                        108.9012527976358,
                                        34.87642887505118
                                    ],
                                    [
                                        108.9012556767554,
                                        34.87721088397039
                                    ],
                                    [
                                        108.9012596356032,
                                        34.87799181266562
                                    ],
                                    [
                                        108.9014208749173,
                                        34.87857677929119
                                    ],
                                    [
                                        108.9016587749596,
                                        34.87883476039117
                                    ],
                                    [
                                        108.9026884748318,
                                        34.87967055834476
                                    ],
                                    [
                                        108.903559094101,
                                        34.88031333841011
                                    ],
                                    [
                                        108.9041129933152,
                                        34.8806982436407
                                    ],
                                    [
                                        108.9123890657289,
                                        34.88549548828831
                                    ],
                                    [
                                        108.9132726368652,
                                        34.8861103614226
                                    ],
                                    [
                                        108.9141565677805,
                                        34.88672811434931
                                    ],
                                    [
                                        108.9150401387165,
                                        34.88734397726769
                                    ],
                                    [
                                        108.9159229898182,
                                        34.88796173029504
                                    ],
                                    [
                                        108.9168069206733,
                                        34.88858155309512
                                    ],
                                    [
                                        108.917484625036,
                                        34.88908540957739
                                    ],
                                    [
                                        108.9181702474251,
                                        34.88958827443605
                                    ],
                                    [
                                        108.9188562298242,
                                        34.89009113928757
                                    ],
                                    [
                                        108.9197469994061,
                                        34.89071492096737
                                    ],
                                    [
                                        108.9206388489802,
                                        34.89133879261668
                                    ],
                                    [
                                        108.9215296191578,
                                        34.8919635647351
                                    ],
                                    [
                                        108.9224203897157,
                                        34.89258743714211
                                    ],
                                    [
                                        108.9233111607086,
                                        34.89321220988156
                                    ],
                                    [
                                        108.9242008524668,
                                        34.89384103322216
                                    ],
                                    [
                                        108.925091624497,
                                        34.89446382676567
                                    ],
                                    [
                                        108.9259823971268,
                                        34.89508662077885
                                    ],
                                    [
                                        108.9268720906866,
                                        34.89571049553028
                                    ],
                                    [
                                        108.9277628646831,
                                        34.89633428061788
                                    ],
                                    [
                                        108.9286597579015,
                                        34.89696310504715
                                    ],
                                    [
                                        108.9305402851283,
                                        34.8983927280629
                                    ],
                                    [
                                        108.9317038747409,
                                        34.89908243042478
                                    ],
                                    [
                                        108.9329207328442,
                                        34.89994519325913
                                    ],
                                    [
                                        108.9352151692333,
                                        34.90154673174229
                                    ],
                                    [
                                        108.9376445813564,
                                        34.90322025023235
                                    ],
                                    [
                                        108.9409428397795,
                                        34.9055046198514
                                    ],
                                    [
                                        108.9437800646009,
                                        34.9074521328556
                                    ],
                                    [
                                        108.9442688334704,
                                        34.90778603175435
                                    ],
                                    [
                                        108.9474911946396,
                                        34.90981242245578
                                    ],
                                    [
                                        108.9478460770258,
                                        34.90998236884429
                                    ],
                                    [
                                        108.9483640044606,
                                        34.90997228672497
                                    ],
                                    [
                                        108.9487138487888,
                                        34.91000624477311
                                    ],
                                    [
                                        108.9493296762556,
                                        34.91023212617399
                                    ],
                                    [
                                        108.9499458646297,
                                        34.91046502830807
                                    ],
                                    [
                                        108.9507974443787,
                                        34.91079185058017
                                    ],
                                    [
                                        108.9513294127129,
                                        34.9111017189982
                                    ],
                                    [
                                        108.9518693001794,
                                        34.91141464670078
                                    ],
                                    [
                                        108.9522652182027,
                                        34.91158755949279
                                    ],
                                    [
                                        108.9528569367139,
                                        34.91149053008207
                                    ]
                                ]
                            ],
                            'type': 'Polygon'
                        },
                        'properties': {
                            'BELONGNAME': '铜川市高新区',
                            'BELONGTO': '610206',
                            'CLOUD_SIGN': 'TCZZ',
                            'CODE': '610201004',
                            'Field_SmUserID': 0,
                            'NAME': '正阳路街道',
                            'NOTE': '',
                            'SQUA': '',
                            'UserID': 0
                        },
                        'type': 'Feature'
                    }
                ]
            };
            layer.setFile('.geojson', JSON.stringify(geojson));
        });
    }

    return utilFunctor(legend, dispatch, 'on');
}